# Project Summary

A cross-platform (Windows, macOS, Linux) VSCode extension that tracks and displays Claude Code token usage by parsing local JSONL session logs. Operates entirely locally with no network calls.

> For detailed field-level schema documentation, see [Log_Format_Reference.md](Log_Format_Reference.md).

---

## Data Location

Claude Code stores session data in JSONL files under `~/.claude/projects/`. Each project directory contains one JSONL file per session, with per-interaction records including token usage.

These files update in real-time as Claude processes prompts, making them ideal for live monitoring.

## File Structure

```
~/.claude/
├── projects/
│   ├── C--Users-dcabr-Repos-myproject/       # Directory named after project path
│   │   ├── <session-uuid>.jsonl              # One file per session
│   │   ├── <session-uuid>/                   # File-history backups
│   │   └── memory/                           # Project memory
│   └── ...
├── stats-cache.json                          # Pre-aggregated usage stats
└── history.jsonl                             # Prompt history across sessions
```

- **No `usage.jsonl` file exists.** Token usage is embedded within each session's JSONL transcript, on entries of `type: "assistant"`.
- Project directory names use `--` as path separators (e.g., `C--Users-dcabr-Repos-myproject`).
- Session files are named `<uuid>.jsonl` and grow indefinitely (no rotation).

## Key Data Fields

Token usage is found at `message.usage` on `type: "assistant"` JSONL entries:

| Field                                | Description                              | Example Value |
|--------------------------------------|------------------------------------------|---------------|
| `message.usage.input_tokens`         | Non-cached input tokens                  | 34            |
| `message.usage.output_tokens`        | Tokens generated by Claude               | 180           |
| `message.usage.cache_creation_input_tokens` | Input tokens written to cache     | 8879          |
| `message.usage.cache_read_input_tokens`     | Input tokens read from cache      | 10414         |
| `message.model`                      | Model used                               | `"claude-opus-4-6"` |
| `timestamp`                          | When the entry was created (ISO-8601)    | `"2026-02-08T13:00:19.950Z"` |
| `requestId`                          | Unique API request identifier            | `"req_011CXveHwjtY6Yq3qazbGMg8"` |

**Cost must be calculated** — no `costUSD` field exists on individual entries. Pricing varies by model family.

**Deduplication required** — streaming produces multiple assistant entries per API request (same `requestId`). Use the last entry per `requestId` to avoid double-counting.

## Interfacing Methods

### File Watching

```typescript
// Watch all session JSONL files for changes
const pattern = new vscode.RelativePattern(
  path.join(os.homedir(), '.claude', 'projects'),
  '**/*.jsonl'
);
const watcher = vscode.workspace.createFileSystemWatcher(pattern);
watcher.onDidChange(async (uri) => {
  // Re-parse changed file, update aggregated totals
});
```

### Reading and Parsing Logs

```typescript
// 1. Read JSONL file
// 2. Filter to type === "assistant" entries
// 3. Deduplicate by requestId (keep last entry per request)
// 4. Extract message.usage fields
// 5. Aggregate by date (timestamp.slice(0, 10))
```

### Alternative: stats-cache.json

For quick high-level summaries, `~/.claude/stats-cache.json` contains pre-aggregated daily token counts and per-model totals. However, it may lag behind real-time and lacks per-project granularity.

## Display Units (Configurable)

The extension provides a configuration screen where users choose how token usage is presented. All UI surfaces (status bar, webview) reflect the selected unit.

| Unit ID         | Label              | Description                                    | Default |
|-----------------|--------------------|------------------------------------------------|---------|
| `tokens`        | Token Count        | Raw token numbers                              | Yes     |
| `cost_usd`      | USD Cost           | Dollar cost from per-model pricing             |         |
| `energy_kwh`    | Energy (kWh)       | Estimated energy consumption per request       |         |
| `trees_burned`  | Trees Burned       | Fun/illustrative environmental impact metric   |         |

Additional fun or educational units can be added over time. Each unit is a conversion function from raw token counts.

## Display Components

- **Status Bar:** Shows today's usage (e.g. `$(pulse) Claude: 2.5k in / 1.2k out`). Tooltip includes full token breakdown and estimated cost. Click opens the details panel. Workspace-aware: shows current project's usage when a workspace is open.
- **Sidebar Panel:** Activity bar webview with per-model token cards for the current workspace project. Each card shows input/output/cache tokens, cost, energy, and trees burned. Includes "View Full Report" and "Settings" links.
- **Webview Details Panel:** Full breakdown table of all projects, grouped by date and model. Columns: Date, Model, Input, Output, Cache Create, Cache Read, Requests, Est. Cost. Per-project subtotals and a grand total across all projects.
- **Commands:** Three registered commands:
  - `claudeTokenTracker.refreshUsage` — Manually refresh all displays
  - `claudeTokenTracker.showDetails` — Open the details webview panel
  - `claudeTokenTracker.openSettings` — Open extension settings in VSCode

## Settings

The extension provides 17 configuration properties under `claudeTokenTracker.*`:

- `displayUnit` — Select display unit (tokens, cost_usd, energy_kwh, trees_burned). Default: `tokens`.
- `showStatusBar` — Show/hide the status bar item. Default: `true`.
- `showSidebar` — Show/hide the sidebar panel. Default: `true`.
- `pricing.{opus|sonnet|haiku}.{input|output|cacheCreation|cacheRead}` — Per-model pricing in USD per million tokens. Configurable for each model family and token type.

## Best Practices

- Handle missing or unexpected fields with try-catch (format has evolved over time).
- Aggregate by date for daily summaries: group by `timestamp.slice(0, 10)`.
- Deduplicate streaming entries by `requestId` before summing tokens.
- Check both `~/.claude/` and `~/.config/claude/` for data (path varies by CLI version).
- Use `os.homedir()` for cross-platform path resolution (Windows, macOS, Linux).
- Privacy: local-only access; no network calls needed.
